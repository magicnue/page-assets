<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件资源站</title>
    <!-- Materialize CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            display: flex;
            min-height: 100vh;
            flex-direction: column;
            background-color: #f4f4f4;
        }
        main {
            flex: 1 0 auto;
            padding-top: 20px;
        }
        .collection .collection-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 15px;
            padding-bottom: 15px;
        }
        .collection .collection-item .item-name {
            flex-grow: 1;
            margin-left: 15px;
            cursor: pointer;
            color: #039be5; /* Link color */
        }
        .collection .collection-item .item-name:hover {
            text-decoration: underline;
        }
        .collection .collection-item .file-actions a {
            margin-left: 10px;
        }
        .breadcrumb-container {
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        .breadcrumb-container a {
            color: #039be5;
        }
        .preloader-wrapper {
            margin: 50px auto;
            display: block;
        }
        .card-panel {
            margin-top: 20px;
        }
        .repo-title {
            font-size: 2rem;
            color: #424242;
        }
        .footer-text {
            font-size: 0.9rem;
            color: #757575;
        }
    </style>
</head>
<body>
    <nav class="blue darken-2">
        <div class="nav-wrapper container">
            <a href="#" id="repo-brand" class="brand-logo">文件资源</a>
            <ul id="nav-mobile" class="right hide-on-med-and-down">
                <li><a id="github-repo-link" href="#" target="_blank">GitHub 仓库</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <h1 id="page-title" class="repo-title">文件列表</h1>
        <div id="breadcrumb-container" class="breadcrumb-container">
            <!-- Breadcrumbs will be populated here -->
        </div>

        <div id="loading" class="center-align">
            <div class="preloader-wrapper big active">
                <div class="spinner-layer spinner-blue-only">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div><div class="gap-patch">
                        <div class="circle"></div>
                    </div><div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
            </div>
            <p>加载中...</p>
        </div>

        <ul id="file-list" class="collection with-header z-depth-1" style="display:none;">
            <!-- File items will be populated here -->
        </ul>
        <div id="empty-folder-message" class="card-panel teal lighten-5" style="display:none;">
            <span class="teal-text text-darken-2">这个文件夹是空的。</span>
        </div>
        <div id="error-message" class="card-panel red lighten-4" style="display:none;">
            <span class="red-text text-darken-2">错误：无法加载文件列表。请检查仓库名称和网络连接。</span>
        </div>
    </main>

    <footer class="page-footer blue darken-3">
        <div class="container">
            <div class="row">
                <div class="col l6 s12">
                    <h5 class="white-text">关于</h5>
                    <p class="grey-text text-lighten-4">这是一个基于 GitHub Pages 的公开文件资源站点。</p>
                </div>
            </div>
        </div>
        <div class="footer-copyright blue darken-4">
            <div class="container footer-text">
                © <span id="current-year"></span> Your Name/Organization. Materialize CSS.
            </div>
        </div>
    </footer>

    <!-- Materialize JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        // ===================================================================================
        // 用户配置区域
        // ===================================================================================
        // !!! 重要: 请修改为你自己的 GitHub 用户名和仓库名 !!!
        const REPO_OWNER = 'magicnue'; // 例如: 'octocat'
        const REPO_NAME = 'page-assets';   // 例如: 'Spoon-Knife'
        const ROOT_FOLDER = 'src'; // 你想要展示内容的根文件夹，通常是 'src'
        // ===================================================================================

        const GITHUB_API_BASE_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/`;
        const GITHUB_PAGES_BASE_URL = `https://${REPO_OWNER}.github.io/${REPO_NAME}/`; // 或者自定义域名

        const fileListEl = document.getElementById('file-list');
        const loadingEl = document.getElementById('loading');
        const errorMessageEl = document.getElementById('error-message');
        const emptyFolderMessageEl = document.getElementById('empty-folder-message');
        const breadcrumbContainerEl = document.getElementById('breadcrumb-container');
        const pageTitleEl = document.getElementById('page-title');
        const repoBrandEl = document.getElementById('repo-brand');
        const githubRepoLinkEl = document.getElementById('github-repo-link');

        document.getElementById('current-year').textContent = new Date().getFullYear();
        if (REPO_OWNER !== 'YOUR_GITHUB_USERNAME' && REPO_NAME !== 'YOUR_REPOSITORY_NAME') {
            repoBrandEl.textContent = REPO_NAME;
            githubRepoLinkEl.href = `https://github.com/${REPO_OWNER}/${REPO_NAME}`;
        }


        async function fetchFiles(path = '') {
            showLoading(true);
            fileListEl.style.display = 'none';
            emptyFolderMessageEl.style.display = 'none';
            errorMessageEl.style.display = 'none';
            fileListEl.innerHTML = ''; // 清空列表

            const apiPath = path ? path : ROOT_FOLDER; // 如果path为空，则使用ROOT_FOLDER
            const apiUrl = GITHUB_API_BASE_URL + apiPath;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                updateBreadcrumbs(apiPath);
                pageTitleEl.textContent = `文件列表: /${apiPath}`;

                if (!Array.isArray(data)) { // 如果不是数组，可能是单个文件信息（不应直接访问）
                    console.warn("Received non-array data, expected directory listing:", data);
                    throw new Error("Invalid data format from API. Expected a directory listing.");
                }

                if (data.length === 0) {
                    emptyFolderMessageEl.style.display = 'block';
                } else {
                    fileListEl.style.display = 'block';
                    // 分离文件夹和文件，并排序
                    const directories = data.filter(item => item.type === 'dir').sort((a, b) => a.name.localeCompare(b.name));
                    const files = data.filter(item => item.type === 'file').sort((a, b) => a.name.localeCompare(b.name));
                    
                    [...directories, ...files].forEach(item => {
                        createListItem(item, apiPath);
                    });
                }

            } catch (error) {
                console.error('Error fetching files:', error);
                errorMessageEl.textContent = `错误：无法加载文件列表 (${error.message})。请检查仓库名称、路径 (${apiPath}) 和网络连接。`;
                errorMessageEl.style.display = 'block';
            } finally {
                showLoading(false);
            }
        }

        function showLoading(isLoading) {
            loadingEl.style.display = isLoading ? 'block' : 'none';
        }

        function getFileIcon(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            switch (extension) {
                case 'pdf': return 'picture_as_pdf';
                case 'doc': case 'docx': return 'description';
                case 'xls': case 'xlsx': return 'grid_on';
                case 'ppt': case 'pptx': return 'slideshow';
                case 'zip': case 'rar': case 'tar': 'gz': return 'archive';
                case 'txt': return 'text_fields';
                case 'jpg': case 'jpeg': case 'png': case 'gif': case 'bmp': case 'svg': return 'image';
                case 'mp3': case 'wav': case 'ogg': return 'audiotrack';
                case 'mp4': case 'mov': case 'avi': case 'wmv': return 'movie';
                case 'js': case 'json': case 'html': case 'css': case 'py': case 'java': case 'c': case 'cpp': return 'code';
                default: return 'insert_drive_file';
            }
        }

        function createListItem(item, currentBasePath) {
            const listItem = document.createElement('li');
            listItem.className = 'collection-item avatar';

            const icon = document.createElement('i');
            icon.className = 'material-icons circle';
            if (item.type === 'dir') {
                icon.textContent = 'folder';
                icon.classList.add('blue', 'lighten-1');
            } else {
                icon.textContent = getFileIcon(item.name);
                icon.classList.add('grey', 'lighten-1');
            }

            const titleSpan = document.createElement('span');
            titleSpan.className = 'title item-name';
            titleSpan.textContent = item.name;

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'secondary-content file-actions';

            if (item.type === 'dir') {
                titleSpan.onclick = () => fetchFiles(item.path);
                const openBtn = document.createElement('a');
                openBtn.className = 'waves-effect waves-light btn-small blue';
                openBtn.innerHTML = '<i class="material-icons left">folder_open</i>打开';
                openBtn.onclick = () => fetchFiles(item.path);
                actionsDiv.appendChild(openBtn);

            } else if (item.type === 'file') {
                // 构建文件在 GitHub Pages 上的直接访问路径
                // 注意: item.path 是从仓库根目录开始的完整路径，例如 "src/subfolder/file.txt"
                // 如果你的 index.html 在仓库根目录，并且 Pages 源也是仓库根目录
                // 那么文件的相对路径就是 item.path
                const filePageUrl = `${item.path}`; // 假设index.html在根目录

                titleSpan.onclick = () => window.open(filePageUrl, '_blank');

                const viewBtn = document.createElement('a');
                viewBtn.href = filePageUrl;
                viewBtn.target = '_blank';
                viewBtn.className = 'waves-effect waves-light btn-small green';
                viewBtn.innerHTML = '<i class="material-icons left">visibility</i>查看';
                actionsDiv.appendChild(viewBtn);

                const downloadBtn = document.createElement('a');
                downloadBtn.href = filePageUrl; // 对于GitHub Pages，直接链接即可下载或在浏览器中打开
                downloadBtn.setAttribute('download', item.name); // 提示浏览器下载
                downloadBtn.className = 'waves-effect waves-light btn-small orange';
                downloadBtn.innerHTML = '<i class="material-icons left">file_download</i>下载';
                actionsDiv.appendChild(downloadBtn);
            }

            listItem.appendChild(icon);
            listItem.appendChild(titleSpan);
            listItem.appendChild(actionsDiv);
            fileListEl.appendChild(listItem);
        }

        function updateBreadcrumbs(currentPath) {
            breadcrumbContainerEl.innerHTML = ''; // 清空面包屑
            
            // 移除开头的 ROOT_FOLDER (如果存在) 以便面包屑从 src 之后开始
            let displayPath = currentPath;
            if (currentPath.startsWith(ROOT_FOLDER + '/')) {
                displayPath = currentPath.substring(ROOT_FOLDER.length + 1);
            } else if (currentPath === ROOT_FOLDER) {
                displayPath = ''; // 如果就是 ROOT_FOLDER，则路径显示为空
            }

            const rootLink = document.createElement('a');
            rootLink.href = '#!';
            rootLink.textContent = ROOT_FOLDER;
            rootLink.onclick = (e) => {
                e.preventDefault();
                fetchFiles(ROOT_FOLDER);
            };
            breadcrumbContainerEl.appendChild(rootLink);

            if (displayPath) {
                const parts = displayPath.split('/');
                let pathAccumulator = ROOT_FOLDER;
                parts.forEach((part, index) => {
                    pathAccumulator += '/' + part;
                    const separator = document.createElement('span');
                    separator.textContent = ' / ';
                    breadcrumbContainerEl.appendChild(separator);

                    if (index === parts.length - 1) { // Last part is current folder, not a link
                        const currentFolderSpan = document.createElement('span');
                        currentFolderSpan.textContent = part;
                        breadcrumbContainerEl.appendChild(currentFolderSpan);
                    } else {
                        const partLink = document.createElement('a');
                        partLink.href = '#!';
                        partLink.textContent = part;
                        const capturedPath = pathAccumulator; // Capture path for closure
                        partLink.onclick = (e) => {
                            e.preventDefault();
                            fetchFiles(capturedPath);
                        };
                        breadcrumbContainerEl.appendChild(partLink);
                    }
                });
            }
        }

        // 初始化 Materialize 组件 (如果有的话，例如 modals, dropdowns)
        M.AutoInit();

        // 初始加载
        if (REPO_OWNER === 'YOUR_GITHUB_USERNAME' || REPO_NAME === 'YOUR_REPOSITORY_NAME') {
            showLoading(false);
            errorMessageEl.innerHTML = '<strong>请先在脚本中配置 <code>REPO_OWNER</code> 和 <code>REPO_NAME</code> 常量！</strong>';
            errorMessageEl.style.display = 'block';
        } else {
            fetchFiles(ROOT_FOLDER); // 从配置的 ROOT_FOLDER 开始
        }
    </script>
</body>
</html>